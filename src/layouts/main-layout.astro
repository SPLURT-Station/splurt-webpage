---
import { getImage } from "astro:assets";
import Linter from "astro-vtbot/components/Linter.astro";
import banner from "/src/assets/backgrounds/banner.png";
import logo from "/src/assets/logos/splurtpaw2_alt3.png";
import AgeGate from "../components/age-gate/age-gate.tsx";
import Footer from "../components/footer/footer.astro";
import MusicPlayer from "../components/music-player/music-player.tsx";
import Navigation from "../components/navigation/navigation.tsx";
import PageHeader from "../components/page-header/page-header.astro";
import { generateStarShadowsWithOpacity } from "../utils/stars";
import "/src/styles/index.css";
import { ClientRouter } from "astro:transitions";
import { SEO } from "astro-seo";
import ReplacementSwap from "astro-vtbot/components/ReplacementSwap.astro";
import { links } from "unplugin-fonts/head";

// Optimize the banner image for background use
const optimizedBanner = await getImage({
	src: banner,
	width: 1920,
	height: 1080,
	format: "webp",
	quality: 80,
});

// Generate random star shadows at build time (similar to SCSS function)
// Using the same counts as the original: 700 small, 200 medium, 100 big
// More cross stars in brighter layers for better visibility
const shadowsSmall = generateStarShadowsWithOpacity(
	700,
	2000,
	{
		min: 0.7,
		max: 0.9,
	},
	0.25 // 25% cross stars in small layer
);
const shadowsMedium = generateStarShadowsWithOpacity(
	200,
	2000,
	{
		min: 0.5,
		max: 0.75,
	},
	0.35 // 35% cross stars in medium layer
);
const shadowsBig = generateStarShadowsWithOpacity(
	100,
	2000,
	{
		min: 0.4,
		max: 0.6,
	},
	0.3 // 30% cross stars in big layer
);

interface Props {
	title?: string;
	description?: string;
	image?: string;
	url?: string;
	type?: string;
	imageStrategy?: "auto" | "thumbnail" | "logo" | "both";
	pageTitle?: string;
}

const {
	title = "S.P.L.U.R.T. Station",
	description = "S.P.L.U.R.T. Station - A NSFW furry roleplaying server for Space Station 13. Join our community for exciting lewdness!",
	image,
	url = Astro.url.href,
	type = "website",
	imageStrategy = "auto",
	pageTitle,
} = Astro.props;

// Get optimized logo for Navigation and AgeGate components
const optimizedLogo = await getImage({
	src: logo,
	format: "webp",
	width: 72,
	height: 72,
});

// Generate OG image path based on current route
// Extract pathname from URL and remove leading slash
const pathname = Astro.url.pathname;
// Remove leading slash and trailing slash if present, use 'index' for home
const ogImagePath =
	pathname === "/" ? "index" : pathname.replace(/^\/|\/$/g, "");
// Construct OG image URL - all paths go to /api/og/{path}.png
const ogImagePathUrl = `/api/og/${ogImagePath}.png`;
const ogImageUrl =
	image || new URL(ogImagePathUrl, Astro.site || Astro.url.origin).href;
---

<html lang="en">
	<head>
		<!-- Unplugin Fonts, for some reason the astro component errors -->
		{links.map((link) => {
			const attrs = link?.attrs || {};
			return <link {...attrs} data-unfont />;
		})}

		<!-- Google tag (gtag.js) -->
		<script
			async
			type="text/partytown"
			src="https://www.googletagmanager.com/gtag/js?id=G-KT0NG9N2C9"
			is:inline
		></script>
		<script type="text/partytown" is:inline>
			window.dataLayer = window.dataLayer || [];
			function gtag(){dataLayer.push(arguments);}
			gtag('js', new Date());

			gtag('config', 'G-KT0NG9N2C9');
		</script>

		<!-- Sitemap link for search engines -->
		<link rel="sitemap" href="/sitemap-index.xml">

		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width">
		<meta name="generator" content={Astro.generator}>

		<SEO
			title={title}
			description={description}
			canonical={url}
			openGraph={{
				basic: {
					title: title,
					type: type,
					image: ogImageUrl,
					url: url,
				},
				optional: {
					description: description,
					siteName: "S.P.L.U.R.T. Station",
					locale: "en_US",
				},
				image: {
					width: 1200,
					height: 630,
					alt: "S.P.L.U.R.T. Station",
					type: "image/png",
				},
			}}
			twitter={{
				card: "summary_large_image",
				title: title,
				description: description,
				image: ogImageUrl,
				imageAlt: "S.P.L.U.R.T. Station",
			}}
			extend={{
				meta: [
					{
						name: "author",
						content: "S.P.L.U.R.T. Station",
					},
					{
						name: "keywords",
						content: "Space Station 13, SS13, Gaming, Multiplayer, S.P.L.U.R.T., SPLURT, furry, furry games, furry roleplay, furry rp, furry roleplaying, furry roleplay games, furry roleplaying games, furry roleplaying server, furry roleplaying servers, furry roleplaying servers list, furry roleplaying servers list 2025, furry roleplaying servers list 2026, furry roleplaying servers list 2027, furry roleplaying servers list 2028, furry roleplaying servers list 2029, furry roleplaying servers list 2030, furry fandom",
					},
					{
						property: "og:color",
						content: "#ff50b0",
					},
					{
						name: "msapplication-navbutton-color",
						content: "#ff50b0",
					},
				],
			}}
		/>
		<ClientRouter />
		<ReplacementSwap />
		<Linter />
	</head>
	<body class="flex flex-col min-h-screen">
		<div id="stars" style={`box-shadow: ${shadowsSmall};`}></div>
		<div id="stars2" style={`box-shadow: ${shadowsMedium};`}></div>
		<div id="stars3" style={`box-shadow: ${shadowsBig};`}></div>
		<!-- Background image and overlay -->
		<div
			class="fixed inset-0 -z-10"
			style={`background-image: url(${optimizedBanner.src}); background-size: cover; background-position: center; background-repeat: no-repeat;`}
			aria-hidden="true"
		></div>
		<div
			class="fixed inset-0 -z-10 backdrop-blur-[1px]"
			style="background-image: linear-gradient(135deg, rgba(5, 0, 15, 0.95) 0%, rgba(25, 5, 30, 0.92) 30%, rgba(60, 15, 40, 0.88) 70%, rgba(120, 30, 80, 0.85) 100%);"
			aria-hidden="true"
		></div>
		<AgeGate client:load logoUrl={optimizedLogo.src} />
		<section data-vtbot-replace="navigation">
			<Navigation client:load logoUrl={optimizedLogo.src} />
		</section>
		<MusicPlayer client:load />
		<section data-vtbot-replace="header">
			{pageTitle && <PageHeader title={pageTitle} />}
		</section>
		<main class="relative z-10" data-vtbot-replace="main">
			<slot />
		</main>
		<Footer />
	</body>
</html>

<style>
	html,
	body {
		margin: 0;
		padding: 0;
		width: 100%;
		min-height: 100%;
	}
</style>
