name: Deploy to VPS (Proxmox LXC)

on:
  push:
    branches: [master, main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    name: Build and Deploy to VPS
    runs-on: [self-hosted, splurt-webpage-production]

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Check Bun installation
        id: check-bun
        run: |
          if command -v bun &> /dev/null; then
            echo "bun-installed=true" >> $GITHUB_OUTPUT
            echo "✅ Bun is already installed"
          else
            echo "bun-installed=false" >> $GITHUB_OUTPUT
            echo "Bun is not installed"
          fi

      - name: Install Bun
        if: steps.check-bun.outputs.bun-installed == 'false'
        run: |
          echo "Installing Bun..."

          # Ensure HOME is set (handle unbound variable)
          export HOME="${HOME:-$(eval echo ~$(whoami))}"

          # Install Bun using the official install script
          curl -fsSL https://bun.sh/install | bash

          # Verify installation and set PATH for subsequent steps
          echo "Bun installed successfully:"
          export BUN_INSTALL="$HOME/.bun"
          export PATH="$BUN_INSTALL/bin:$PATH"
          echo "BUN_INSTALL=$BUN_INSTALL" >> $GITHUB_ENV
          echo "PATH=$BUN_INSTALL/bin:$PATH" >> $GITHUB_ENV
          bun --version

      - name: Upgrade Bun
        run: |
          echo "Upgrading Bun to latest version..."
          bun upgrade

      - name: Install dependencies
        run: bun install

      - name: Build application
        run: bun run build

      - name: Deployment complete
        run: |
          echo "✅ Build completed successfully!"
          echo "Application built and ready at: $(pwd)/dist"
