name: Deploy to VPS (Proxmox LXC)

on:
  push:
    branches: [master, main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    name: Build and Deploy to VPS
    runs-on: [self-hosted, splurt-webpage-production]

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Check Bun installation
        id: check-bun
        run: |
          if command -v bun &> /dev/null; then
            echo "bun-installed=true" >> $GITHUB_OUTPUT
            echo "✅ Bun is already installed"
          else
            echo "bun-installed=false" >> $GITHUB_OUTPUT
            echo "Bun is not installed"
          fi

      - name: Install Bun
        if: steps.check-bun.outputs.bun-installed == 'false'
        run: |
          echo "Installing Bun..."

          # Ensure HOME is set (handle unbound variable)
          export HOME="${HOME:-$(eval echo ~$(whoami))}"

          # Install Bun using the official install script
          curl -fsSL https://bun.sh/install | bash

          # Verify installation and set PATH for subsequent steps
          echo "Bun installed successfully:"
          export BUN_INSTALL="$HOME/.bun"
          export PATH="$BUN_INSTALL/bin:$PATH"
          echo "BUN_INSTALL=$BUN_INSTALL" >> $GITHUB_ENV
          echo "PATH=$BUN_INSTALL/bin:$PATH" >> $GITHUB_ENV
          bun --version

      - name: Upgrade Bun
        run: |
          echo "Upgrading Bun to latest version..."
          export HOME="${HOME:-$(eval echo ~$(whoami))}"
          export BUN_INSTALL="${BUN_INSTALL:-$HOME/.bun}"
          export PATH="$BUN_INSTALL/bin:$PATH"
          bun upgrade

      - name: Install dependencies
        run: |
          export HOME="${HOME:-$(eval echo ~$(whoami))}"
          export BUN_INSTALL="${BUN_INSTALL:-$HOME/.bun}"
          export PATH="$BUN_INSTALL/bin:$PATH"
          bun install

      - name: Build application
        run: |
          export HOME="${HOME:-$(eval echo ~$(whoami))}"
          export BUN_INSTALL="${BUN_INSTALL:-$HOME/.bun}"
          export PATH="$BUN_INSTALL/bin:$PATH"
          bun run build

      - name: Verify build output
        run: |
          if [ ! -d "dist/client" ]; then
            echo "❌ Build failed: dist/client directory not found"
            exit 1
          fi
          if [ ! -d "dist/server" ]; then
            echo "❌ Build failed: dist/server directory not found (server entrypoint required)"
            exit 1
          fi
          if [ ! -f "dist/server/entry.mjs" ]; then
            echo "❌ Build failed: dist/server/entry.mjs not found (PM2 requires this entrypoint)"
            exit 1
          fi
          echo "✅ Build successful:"
          echo "  - Static files: dist/client/"
          echo "  - Server entrypoint: dist/server/entry.mjs"
          ls -la dist/server/entry.mjs

      - name: Check PM2 installation
        id: check-pm2
        run: |
          if command -v pm2 &> /dev/null; then
            echo "pm2-installed=true" >> $GITHUB_OUTPUT
            echo "✅ PM2 is already installed"
          else
            echo "pm2-installed=false" >> $GITHUB_OUTPUT
            echo "PM2 is not installed"
          fi

      - name: Install PM2
        if: steps.check-pm2.outputs.pm2-installed == 'false'
        run: |
          echo "Installing PM2..."
          export HOME="${HOME:-$(eval echo ~$(whoami))}"
          export BUN_INSTALL="${BUN_INSTALL:-$HOME/.bun}"
          export PATH="$BUN_INSTALL/bin:$PATH"
          bun install -g pm2
          pm2 --version

      - name: Create logs directory
        run: |
          mkdir -p logs
          echo "✅ Logs directory created"

      - name: Reload existing PM2 process
        run: |
          export HOME="${HOME:-$(eval echo ~$(whoami))}"
          export BUN_INSTALL="${BUN_INSTALL:-$HOME/.bun}"
          export PATH="$BUN_INSTALL/bin:$PATH"
          pm2 stop ecosystem.config.cjs || true
          echo "✅ Stopped existing PM2 process (if any)"
          pm2 start ecosystem.config.cjs
          pm2 save
          pm2 startup || echo "⚠️ PM2 startup command failed (may need manual setup)"

      - name: Deployment complete
        run: |
          echo "✅ Build and deployment completed successfully!"
          echo "Application is running with PM2"
          echo "Application built and ready at: $(pwd)/dist"
