name: Update Dependencies

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: "0 9 * * 1"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-dependencies:
    name: Check for Outdated Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Check for outdated dependencies
        id: check
        run: |
          echo "Checking for outdated dependencies..."
          # Bun doesn't have a built-in outdated command, use bunx npm-check-updates or check package.json
          # For now, we'll use bun update --dry-run to check for updates
          if bun update --dry-run 2>&1 | grep -q "up to date"; then
            echo "outdated=false" >> $GITHUB_OUTPUT
            echo "All dependencies are up to date!"
          else
            echo "outdated=true" >> $GITHUB_OUTPUT
            echo "Updates available:"
            bun update --dry-run || echo "Updates may be available"
          fi

      - name: Update compatible dependencies
        if: steps.check.outputs.outdated == 'true'
        run: |
          echo "Updating dependencies to latest compatible versions..."
          bun update

      - name: Create Pull Request
        if: steps.check.outputs.outdated == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "deps: update dependencies to latest compatible versions"
          title: "Update Dependencies"
          body: |
            ## üì¶ Dependency Updates

            This PR updates dependencies to their latest compatible versions using `bun update`.

            ### Changes
            - Updated dependencies to latest semver-compatible versions
            - Lock file updated automatically by Bun

            ### Verification
            - [ ] Dependencies updated successfully
            - [ ] Tests pass
            - [ ] Build works correctly

            ---
            *This PR was created automatically by the dependency update workflow using Bun's built-in dependency management.*
          branch: update-dependencies
          delete-branch: true

  check-major-updates:
    name: Check for Major Updates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Check for major updates
        run: |
          echo "üìã Checking for all available updates (including major versions)..."
          echo ""
          echo "üì¶ Checking package.json dependencies..."
          echo ""
          echo "‚ÑπÔ∏è To update to latest versions (including breaking changes), you can:"
          echo "   1. Manually update versions in package.json"
          echo "   2. Run: bun update <package-name>"
          echo ""
          echo "‚ö†Ô∏è Note: Major version updates may contain breaking changes."
          echo "   Review the changelog before updating manually."
          echo ""
          echo "‚úÖ Use 'bun outdated' (if available) or check package.json for available updates"
